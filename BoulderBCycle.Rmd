---
title: "Boulder B-Cycle data analysis by Monish Sunku Prabhakar"
output:
  html_document:
    toc: true
    theme: united
---
# __Introduction__
This project analyses Boulder B-cycle data to understand and document any patterns from 2013 to Early 2016. The data analysis in this project is through summaries and visualizations. Also part of the project is to try and apply Machine Learning on the numerical data to try and make predictions. 

### How is the analysis divided?
The analysis is divided into 3 big sections:

1. Summary of Data

2. Data Visualizations 

3. Machine Learning to predict the Pass Type 

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10}
suppressMessages(library(ggplot2))
suppressMessages(library(caret))
suppressMessages(library(ggmap))
```

# __1. Summary of Data__
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10}
# Load the dataset 
dataset <- read.csv("Boulder Data.csv", header = TRUE)

# It looks like RTD and 14th and Canyon are supposed to mean the same location, so 
# search and replace. This is okay because our analysis about stations doesn't change
# as 14th and Canyon/RTD wasn't the top of the pile
# NOTE: This was added as analysis was done below in the Station section
dataset$Checkout.Station <- sapply(dataset$Checkout.Station, 
                                                 function(x) gsub("RTD", "14th & Canyon", x))
dataset$Return.Station <- sapply(dataset$Return.Station, 
                                                 function(x) gsub("RTD", "14th & Canyon", x))

# Load the location data
locationset <- read.csv("Boulder Location.csv", header = TRUE)

# Peak into the data
head(dataset)

# Get the summary of the data
summary(dataset)

# Convert from character string into a time/date object
dataset$Checkout.Date <- strptime(dataset$Checkout.Date, "%m/%d/%Y")
dataset$Return.Date <- strptime(dataset$Return.Date, "%m/%d/%Y")
dataset$Checkout.Time <- strptime(dataset$Checkout.Time, format = "%H:%M:%S")
dataset$Return.Time <- strptime(dataset$Return.Time, format = "%H:%M:%S")

# Convert the Day of the Week into an ordered variable
dataset$Checkout.Day.of.Week <- ordered(dataset$Checkout.Day.of.Week, 
                                        levels = c("Sunday", "Monday", "Tuesday", 
                                                   "Wednesday", "Thursday", "Friday",
                                                   "Saturday"))
```

### The structure of the dataset
There are 248544 observations of 13 variables. The variables include Checkout/Return Stations, Checkout/Return Time, Type of Pass, Day of the Week, Trip Duration, Bike Number and Rider/Operator number. Also included is a location dataset with latitude and longitude information along with other information about the Checkout/Return stations

### Corrections to the dataset
There are some errors in the "Rider.Home.System" column. This data is supposed to be data for Boulder but the home system was set to Denver and Houston, this is not correct. This is not a big deal though because this variable/column data is probably not that important in my analysis because it's a constant. 

NOTE: I also made corrections to Checkout/Return Station "RTD", which is really "14th & Canyon" but entered incorrectly as RTD. I found this error later in my project as I did my analysis but I corrected it early on. 

# __2. Data Visualizations__
This section involves a lot of visualizations. It's a combination of univariate and multivariate plots, with focus on one variable at a time.

### Riders or Operators
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig1: Rider/Operator Count", fig.align = "center"}
# Bar plot of riders with more than 200 rides
riders <- subset(dataset, 
                 Rider.or.Operator.Number %in% levels(dataset$Rider.or.Operator.Number)
                 [table(dataset$Rider.or.Operator.Number) >= 200])

ggplot(riders, aes(Rider.or.Operator.Number)) + geom_bar() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  scale_y_continuous(breaks = seq(0, 10000, by = 500)) +
  xlab("Rider or Operator Number") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig2: Rider/Operator Count seperated by Pass Type", fig.align = "center"}
# Facet it with the Pass type
ggplot(riders, aes(Rider.or.Operator.Number)) + 
  geom_bar(aes(fill = Entry.Pass.Type)) + 
  facet_wrap(~Entry.Pass.Type, ncol = 1, scales = "free_y") + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  guides(fill = FALSE) +
  xlab("Rider or Operator Number") +
  ylab("Count")
```

NOTE: There were a lot of riders between 1-200 rides and to understand any patterns better, the data was subset to riders with 200 or more rides.

The following trends with using a subset of the data can be noted. 

1. Some riders really like to use the B-cycle for their rides. Faceting it by the pass type, we get a better understanding of what type of passes they like to use. Annual Pass is the biggest winner among people who use the bikes often(not surprising) but there was a rider who did a little more than 200 rides using the 24 hour pass(surprised that the person didn't think of other cheaper options). 

2. The number of rides by riders using Maintenance pass is very interesting, there are a lot of rides by a few users. This indicates that these were operators who regularly used and fixed the
bikes.

### Pass Type
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig3: Pass Type Count", fig.align = "center"}
# Bar plot of the post popular pass type
ggplot(dataset, aes(Entry.Pass.Type)) + 
  geom_bar(aes(fill = Entry.Pass.Type)) + 
  scale_y_continuous(breaks = seq(0, 120000, by = 2500)) +
  guides(fill = FALSE) + 
  xlab("Pass Type") +
  ylab("Count") 
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig4: Pass Type Count seperatred by Day of the Week", fig.align = "center"}
# Bar plot of the post popular pass type faceted by day of the week
ggplot(dataset, aes(Entry.Pass.Type)) + 
  geom_bar(aes(fill = Entry.Pass.Type)) + 
  scale_y_continuous(breaks = seq(0, 120000, by = 2500)) +
  facet_wrap(~Checkout.Day.of.Week) + 
  guides(fill = FALSE) + 
  xlab("Pass Type") +
  ylab("Count") 
```

1. There are 4 pass types as noted from the plot above. It is clear that the Anuual pass is definitely the most popular, followed by the 24-hour type pass. 150-day and 7-day passes pale in comparison. Maintainance is another one which has relatively high use compared to 7-day and Semester(150-day) type.

2. From Fig4 one thing which stands out is that 24-hour pass type is used way more than Annual pass on the weekends. whereas on the weekdays Annual pass is still the most widely used. Semester and 7-day pass usage is still very low.  

### Bike Numbers 
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig5: Bike# Count seperated by Pass Type", fig.align = "center"}
# Subset for bikes with 100 or more rides
bikes <- subset(dataset, 
                Bike.Number %in% levels(dataset$Bike.Number)
                [table(dataset$Bike.Number) >= 100])

# Bar Plot of the bike numbers faceted by pass type
ggplot(bikes, aes(Bike.Number)) + geom_bar(aes(fill = Entry.Pass.Type)) + 
  theme(axis.text.x = element_text(angle = 90, face = "bold", size = 6)) +
  facet_wrap(~Entry.Pass.Type, ncol = 1, scales = "free_y") +
  guides(fill = FALSE) +
  xlab("Bike#") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig6: Bike# Count seperated by Day of the Week", fig.align = "center"}
# Bar Plot of the bike numbers faceted by day of the week
ggplot(bikes, aes(Bike.Number)) + geom_bar(aes(fill = Checkout.Day.of.Week)) + 
  theme(axis.text.x = element_text(angle = 90, face = "bold", size = 6)) +
  facet_wrap(~Checkout.Day.of.Week, ncol = 1, scales = "free_y") +
  guides(fill = FALSE) +
  xlab("Bike#") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig7: Bike# Count seperated by Pass Type & Day of the Week", fig.align = "center"}
# Bar Plot of the bike numbers faceted by day of the week and pass type
ggplot(bikes, aes(Bike.Number)) + geom_bar(aes(fill = Checkout.Day.of.Week)) + 
  theme(axis.text.x = element_text(angle = 90, face = "bold", size = 6)) +
  facet_wrap(Entry.Pass.Type~Checkout.Day.of.Week, ncol = 7, scales = "free_y") +
  guides(fill = FALSE) +
  xlab("Bike#") +
  ylab("Count")
```

Was not expecting any trends when analyzing bike numbers but surprisingly there are some trends.

Except for 7-day and Semester pass types, the bike numbers in the middle seem to be most used. This might be related to the stations they are at, as there are stations which are more popular than other ones as we will see below. 

### Day of the week
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig8: Day of the Week Count", fig.align = "center"}
# Bar plot of the day of the week
ggplot(dataset, aes(Checkout.Day.of.Week)) + geom_bar() +
  guides(fill = FALSE) +
  xlab("Day of the Week") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig9: Day of the Week Count seperated by Pass Type", fig.align = "center"}
# Facet by pass type
ggplot(dataset, aes(Checkout.Day.of.Week)) + geom_bar(aes(fill = Entry.Pass.Type)) +
  facet_wrap(~Entry.Pass.Type, ncol = 1, scales = "free_y") + 
  guides(fill = FALSE) +
  xlab("Day of the Week") +
  ylab("Count")
```

1. Friday is overall the most popular day of the week for ridership, followed by Thursday(surprising) and then Saturday. Monday, Tuesday & Wednesday usage is very close, whereas Sunday usage is markedly lower compared to other days

2. When looking at the data faceted by the pass type, Annual pass holders like to use their passes on weekdays(the distribution is almost gaussian like). It is completely opposite for the users of 24-hour pass type, they like riding on weekends(as we noted in the Pass Type section)

3. Maintenance rides seems to happen mostly on weekends. Semester pass holders like to use their pass on the weekdays with Tuesday being the most popular. 

4. In the case of 7-day pass, there is no visible trend but Thursday is most popular followed by Friday & Saturday.

### Trip Duration
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig9:Box plots of Trip Duration", fig.align = "center"}
# Get a summary of Trip Duration 
summary(dataset$Trip.Duration..Minutes.)
boxplot(dataset[, 13], main = names(dataset)[13])

# Remove the negative values and convert it into positive 
# and also remove outliers(by playing around with the box plot)
duration <- subset(dataset, 
                   dataset$Trip.Duration..Minutes. > 0 & 
                   !is.na(dataset$Trip.Duration..Minutes.) &
                   dataset$Trip.Duration..Minutes. < 60 )

# The box plot looks much better after removing the outliers
boxplot(duration[, 13], main = names(dataset)[13])
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig9: Trip Duration Distribution", fig.align = "center"}
# Histogram after some cleaning(remove very high values, seem like errors)
ggplot(duration, aes(Trip.Duration..Minutes.)) + 
  geom_histogram(color = "white", bins = 30) +
  scale_x_continuous(breaks = seq(0, 60, 2)) +
  xlab("Trip Duration") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig10: Trip Duration distribution seperated by Pass Type", fig.align = "center"}
# Faceted by pass type
ggplot(duration, aes(Trip.Duration..Minutes.)) + 
  geom_histogram(color = "white", aes(fill = Entry.Pass.Type), bins = 30) +
  scale_x_continuous(breaks = seq(0, 60, 2)) + 
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_grid(~Entry.Pass.Type) +
  guides(fill = FALSE) +
  xlab("Trip Duration") +
  ylab("Count") 
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig11: Trip Duration distribution seperated by Day of the Week", fig.align = "center"}
# Faceted by day of the week
ggplot(duration, aes(Trip.Duration..Minutes.)) + 
  geom_histogram(color = "white", aes(fill = Checkout.Day.of.Week), bins = 30) +
  scale_x_continuous(breaks = seq(0, 60, 2)) + 
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_grid(~Checkout.Day.of.Week) +
  guides(fill = FALSE) +
  xlab("Trip Duration") +
  ylab("Count") 
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig12: Trip Duration distribution seperated by Pass Type and Day of the Week", fig.align = "center"}
# Faceted by day of the week and pass type
ggplot(duration, aes(Trip.Duration..Minutes.)) + 
  geom_histogram(color = "white", aes(fill = Checkout.Day.of.Week), bins = 30) +
  scale_x_continuous(breaks = seq(0, 60, 2)) + 
  theme(axis.text.x = element_text(angle = 90)) + 
  facet_grid(Entry.Pass.Type~Checkout.Day.of.Week, scales = "free_y") +
  guides(fill = FALSE) +
  xlab("Trip Duration") +
  ylab("Count")
```
This section also uses a subset of the data. There were a lot of outliers in trip duration, so the trip duration to 60 minutes and the subset of the data was used for visualizations. 

1. Overall, the trip duration is a gaussian distribution with the peak at 4-5 minutes and falls pretty hard and kind of stabilizes from the 32 minute mark. 

2. Faceting it by pass type, for the 24 hour pass type, the most common trip duration is 12-13 minutes, 10-13 minutes for 7-day pass, 4-5 minutes for Annual, 1 minute for Maintenance(quick maintenance!) and 6-7 minutes for semester type.

3. When looking at the plots by the day of the week, 5ish minute period still is the most popular on weekdays but not on weekends. With 10-12 minute seeming to be more popular, may be this is due to the fact that people are not in a hurry on the weekends.

4. Combining the pass type and weekday, the annual pass holders trip duration pattern doesn't change much, point 3 still holds true. For 24 hour pass type, the trip duration seems to be in the upper ranges, 10+ minutes. The 7-day pass type trip duration doesn't show a clear pattern from the plots. 1-minute maintenance seems to be the most common turn around time. 7-8 minutes trip duration seems to still be the most common for semester type pass.

### Checkout Station
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig13: Checkout Station Count", fig.align = "center"}
# Bar plot of the checkout station
ggplot(dataset, aes(Checkout.Station)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 270)) + 
  guides(fill = FALSE) +
  xlab("Checkout Station") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig14: Checkout Station Count seperated by Day of the Week", fig.align = "center"}
# Bar plot of the checkout station faceted by day of the week
ggplot(dataset, aes(Checkout.Station)) + 
  geom_bar(aes(fill = Checkout.Day.of.Week)) +
  theme(axis.text.x = element_text(angle = 270)) + 
  facet_wrap(~Checkout.Day.of.Week, ncol = 1, scales = "free_y") + 
  guides(fill = FALSE) +
  xlab("Checkout Station") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig15: Checkout Station Count seperated by Pass Type", fig.align = "center"}
# Bar plot of the checkout station faceted by pass type
ggplot(dataset, aes(Checkout.Station)) + 
  geom_bar(aes(fill = Entry.Pass.Type)) +
  theme(axis.text.x = element_text(angle = 270)) + 
  facet_wrap(~Entry.Pass.Type, ncol = 1, scales = "free_y") + 
  guides(fill = FALSE) +
  xlab("Checkout Station") +
  ylab("Count") 
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig16: Trip Duration distribution seperated by Checkout Station", fig.align = "center"}
# Facet Trip duration by checkout station
ggplot(duration, aes(Trip.Duration..Minutes.)) + 
  geom_histogram(color = "white", aes(fill = Checkout.Station), bins = 30) +
  scale_x_continuous(breaks = seq(0, 60, 2)) + 
  facet_wrap(~Checkout.Station, ncol = 5) +
  guides(fill = FALSE) +
  xlab("Trip Duration") +
  ylab("Count")
```

1. 15th & Pearl, 13th and Spruce are the 2 most poular check out stations in Boulder. There is a close tie between 11th and Pearl and Municipal Building stations. Greenhouse and Gunbarrel North are the least used stations, 14th and Walnut office might be an error as this location doesn't have lattitude, longitude listed.

2. Faceting it by the day of the week, 15th & Pearl is still the most popular checkout station. With 13th and Spruce along with Municipal building being the 2nd most popular checkout stations from Mon-Thu and 11th & Pearl from Fri-Sun. 

3. Analyzing the checkout stations by the pass type, 15th & Pearl is still the most popular checkout station for all pass types except for the semester pass type. For the 24-hour pass type, 11th and Pearl is the 2nd most popular checkout station followed by 19th @ Broadway. The village seems to be the 2nd most popular station for the 7-day pass type. The Annual pass distribution doesn't change much with the overall pattern from point 1 because this is the most popular pass type

4. One thing to be noted are the spikes in maintenance in locations like The Village and 26th @ Pearl which are not in line with the overall checkout station popularity pattern. This might indicate that the bikes there might have been subject to more rough use or a batch of bikes which were stationed there had some defect. 

5. Faceting the trip duration by Checkout station there are not any major surprises and the overall pattern across the popular stations seems to be still true, ride times being in the 6-10 minutes range

### Return Station
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig17: Return Station Count seperated by Pass Type", fig.align = "center"}
# Bar plot of the return station
ggplot(dataset, aes(Return.Station)) + 
  geom_bar() +
  theme(axis.text.x = element_text(angle = 270)) + 
  guides(fill = FALSE) +
  xlab("Return Station") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig18: Return Station Count seperated by Day of the Week", fig.align = "center"}
# Bar plot of the return station faceted by day of the week
ggplot(dataset, aes(Return.Station)) + 
  geom_bar(aes(fill = Checkout.Day.of.Week)) +
  theme(axis.text.x = element_text(angle = 270)) + 
  facet_wrap(~Checkout.Day.of.Week, ncol = 1, scales = "free_y") + 
  guides(fill = FALSE) +
  xlab("Checkout Station") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig19: Return Station Count seperated by Pass Type", fig.align = "center"}
# Bar plot of the return station faceted by pass type
ggplot(dataset, aes(Return.Station)) + 
  geom_bar(aes(fill = Entry.Pass.Type)) +
  theme(axis.text.x = element_text(angle = 270)) + 
  facet_wrap(~Entry.Pass.Type, ncol = 1, scales = "free_y") + 
  guides(fill = FALSE) +
  xlab("Return Station") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig20: Trip Duration distribution seperated by Return Station", fig.align = "center"}
# Facet Trip duration by return station
ggplot(duration, aes(Trip.Duration..Minutes.)) + 
  geom_histogram(color = "white", aes(fill = Return.Station), bins = 30) +
  scale_x_continuous(breaks = seq(0, 60, 2)) + 
  facet_wrap(~Return.Station, ncol = 5) +
  guides(fill = FALSE) +
  xlab("Trip Duration") +
  ylab("Count")
```

No surprises from the Return Station analysis, most if not all of the points from the pervious section apply here as well. 

### Checkout Date
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig21: Checkout Date distribution", fig.align = "center"}
# Plot histogram of checkout 
ggplot(dataset, aes(Checkout.Date)) + 
  geom_histogram(color = "white", bins = 50) +
  scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "3 months") + 
  guides(fill = FALSE) + 
  xlab("Checkout Date") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig22: Checkout Date distribution seperated by Pass Type", fig.align = "center"}
# Facet it by pass type
ggplot(dataset, aes(Checkout.Date)) + 
  geom_histogram(aes(fill = Entry.Pass.Type), color = "white", bins = 50) +
  facet_wrap(~Entry.Pass.Type, ncol = 1, scale = "free_y") + 
  scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "3 months") + 
  guides(fill = FALSE) + 
  xlab("Checkout Date") +
  ylab("Count") 
```

1. The number of checkouts has progressively increased over the years from year to year. There is definitly a pattern in terms of usage, the summer(May-August) months seeing an increase in checkouts but there is a dip on on either side of the summer months. This definitely makes sense as people tend to ride less in the winter months. Among the popular summer months, July-August have the biggest checkouts across the years

2. Viewing the plots by the type of the pass, we can see that all pass types have seen an increase in usage since Boulder B-cycle was introduced. 7-day pass saw a big increase in the summer of 2015 and the Semester type pass also saw a big increase since it was introduced in early 2014. 

3. Among the annual pass holders, October of 2015 had more users than any other month in the warmer months. This is surprising, I guess October must have been warm or there must have been a lot of events in the Boulder area.  

4. Maintenance generally follows the trend of an increase in the number of instances of maintenance in the summer months and a decrease in the colder months. One anamoly was that in April of 2015 had the highest instances of maintenance for that year but it wasn't the most popular month in terms of ridership. This might also indicate that the Boulder B-cycle organization might have been preparing in advance for the popular ridership summer months. This might be a good guess because the maintenance was lower in the months following April for 2015 across all pass types.

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig23: Checkout Date distribution seperated by Day of the Week", fig.align = "center"}
# Facet it by day of the week
ggplot(dataset, aes(Checkout.Date)) + 
  geom_histogram(aes(fill = Checkout.Day.of.Week), color = "white", bins = 50) +
  facet_wrap(~Checkout.Day.of.Week, ncol = 1, scale = "free_y") + 
  scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "6 months") + 
  guides(fill = FALSE) + 
  xlab("Checkout Date") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig24: Checkout Date distribution seperated by Pass Type and Day of the Week", fig.align = "center"}
# Facet by pass type and day of the week
ggplot(dataset, aes(Checkout.Date)) + 
  geom_histogram(aes(fill = Checkout.Day.of.Week), color = "white", bins = 50) +
  facet_wrap(Entry.Pass.Type~Checkout.Day.of.Week, ncol = 7, scale = "free_y") + 
  scale_x_datetime(date_labels = "%Y-%m-%d", date_breaks = "4 months") + 
  theme(axis.text.x = element_text(angle = 270)) + 
  guides(fill = FALSE) + 
  xlab("Checkout Date") +
  ylab("Count")
```

1. Analysing checkouts divided by the day of the week. Only Tue-Wed deviate from the general trend that August is the most popular month followed by July. In the case of Tue-Wed the roles get reversed. 

2. Doing a multivariate analysis we can see finer trends in popular days across months and across pass types. 

### Checkout/Return Time(Part 1)
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig25: Checkout Time Distribution", fig.align = "center"}
# Bar plot of checkout time 
ggplot(dataset, aes(Checkout.Time)) + 
  geom_histogram(color = "white", bins = 50) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "30 min") + 
  guides(fill = FALSE) + 
  xlab("Checkout Time") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig26: Return Time Distribution", fig.align = "center"}
# Bar plot of return time
ggplot(dataset, aes(Return.Time)) + 
  geom_histogram(color = "white", bins = 50) +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "30 min") + 
  guides(fill = FALSE) + 
  xlab("Return Time") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig27: Checkout Time distribution seperated by Pass Type", fig.align = "center"}
# Bar plot of checkout time faceted by pass type 
ggplot(dataset, aes(Checkout.Time)) + 
  geom_histogram(aes(fill = Entry.Pass.Type), color = "white", bins = 50) +
  facet_wrap(~Entry.Pass.Type, ncol = 1, scale = "free_y") +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "30 min") + 
  guides(fill = FALSE) + 
  xlab("Checkout Time") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig28: Return Time distribution seperated by Pass Type", fig.align = "center"}
# Bar plot of return time faceted by pass type 
ggplot(dataset, aes(Return.Time)) + 
  geom_histogram(aes(fill = Entry.Pass.Type), color = "white", bins = 50) +
  facet_wrap(~Entry.Pass.Type, ncol = 1, scale = "free_y") +
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "30 min") + 
  guides(fill = FALSE) + 
  xlab("Return Time") +
  ylab("Count")
```

1. Checkout/Return times start slowly a little before 7(early, so expected), with a big increase just after 7:00. From that time on, the checkouts/returns slightly decrease but then increase again from 10:00 to 11:15, then seeing a dip again at around 13:00 followed by an increase till 15:00. There is a dip again followed by an increase in ridership after 18:00.

2. The return and checkout times follow each other closely because the overall most popular times in Boulder is less than 10 minutes.

3. 24 hour pass type holders checkout/return times start off strong in the morning and slowly decrease except for one spike at 10:00 and then starts increasing at around 14:30, hitting a peak at 18:00 and then slowly decreasing.

4. Among 7-day pass holders 14:30 seems to be the peak for checkout/returns. The increase in checkout/return towards the peak at 14:30 starts at around 11:30. This pattern also holds true for semester pass holders. 

5. Annual pass type usage patterns follows the overall pattern described in point 1. Whereas, for maintenance, the peak is in the morning before 11:00 followed by a big dip and then a big increase after 15:00  

### Checkout/Return Time(Part 2)
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig29: Checkout Time distribution seperated by Day of the Week", fig.align = "center"}
# Facet by day of the week
ggplot(dataset, aes(Checkout.Time)) + 
  geom_histogram(aes(fill = Checkout.Day.of.Week), color = "white", bins = 50) +
  facet_wrap(~Checkout.Day.of.Week, ncol = 1, scale = "free_y") + 
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "30 min") + 
  theme(axis.text.x = element_text(angle = 270)) + 
  guides(fill = FALSE) + 
  xlab("Checkout Time") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig30: Return Time distribution seperated by Day of the Week", fig.align = "center"}
ggplot(dataset, aes(Return.Time)) + 
  geom_histogram(aes(fill = Checkout.Day.of.Week), color = "white", bins = 50) +
  facet_wrap(~Checkout.Day.of.Week, ncol = 1, scale = "free_y") + 
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "30 min") + 
  theme(axis.text.x = element_text(angle = 270)) + 
  guides(fill = FALSE) + 
  xlab("Return Time") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig31: Checkout Time distribution seperated by Pass Type & Day of the Week", fig.align = "center"}
# Facet by pass type and day of the week
ggplot(dataset, aes(Checkout.Time)) + 
  geom_histogram(aes(fill = Checkout.Day.of.Week), color = "white", bins = 50) +
  facet_wrap(Entry.Pass.Type~Checkout.Day.of.Week, scale = "free_y") + 
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hour") + 
  theme(axis.text.x = element_text(angle = 270)) + 
  guides(fill = FALSE) + 
  xlab("Checkout Time") +
  ylab("Count")
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig32: Return Time distribution seperated by Pass Type & Day of the Week", fig.align = "center"}
ggplot(dataset, aes(Return.Time)) + 
  geom_histogram(aes(fill = Checkout.Day.of.Week), color = "white", bins = 50) +
  facet_wrap(Entry.Pass.Type~Checkout.Day.of.Week, scale = "free_y") + 
  scale_x_datetime(date_labels = "%H:%M", date_breaks = "2 hour") + 
  theme(axis.text.x = element_text(angle = 270)) + 
  guides(fill = FALSE) + 
  xlab("Return Time") +
  ylab("Count")
```

1. Among 24 hour pass holders from Tue-Thu the checkout/return pattern is different from Fri-Mon. Tue-Thu checkout/returns doesn't dip as much in the middle of the day compared to Fri-Mon.

2. 7-day pass checkout/returns peak at around 15:00 from Mon-Thu, with Fri-Sun seeing peaks and drops throughout the day. The same pattern applies for semester pass holders. 

3. Annual pass holders like to use the service around the 11:00, 15:00 and 18:00 time periods on weekdays. Where as on Saturdays and Sundays the peak usage in the morning and evenings

4. Maintenance peaks at 15:00 on weekdays and mornings/evenings on Saturdays and Sunday(with a big drop in maintenance in the middle)

### Heat Map of Stations
```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig33: Heat Map of Checkout Stations", fig.align = "center"}
# Get the map of Boulder, CO
map = get_map(location = "Boulder, Colorado", zoom = 13, maptype = "terrain")

# Convert the location access count into a table
checkoutcount <- as.data.frame(table(dataset$Checkout.Station))
returncount <- as.data.frame(table(dataset$Return.Station))

# Add a new column for checkout count and return count
locationset["Checkout.Count"] <- NA
locationset["Return.Count"] <- NA

# Go through each element of the locationcount data frame and add the count
# corresponding to the location
for (i in 1:nrow(checkoutcount)){
  indextoadd <- grep(checkoutcount[i, "Var1"], locationset$Checkout.Station)
  locationset[indextoadd, "Checkout.Count"] <- checkoutcount[i, "Freq"]
}

for (i in 1:nrow(returncount)){
  indextoadd <- grep(returncount[i, "Var1"], locationset$Return.Station)
  locationset[indextoadd, "Return.Count"] <- returncount[i, "Freq"]
}

# Pass in the map object for plotting a heat map of the checkout stations
ggmap(map) +
  geom_point(data = locationset, 
             aes(y = Checkout.Station.Latitude, 
                 x = Checkout.Station.Longitude,
                 size = Checkout.Count),
             color = "red", alpha = 0.5) +
  scale_size(range = c(0, 15)) + 
  guides(fill = FALSE)
```

```{r, warning = FALSE, echo = FALSE, fig.width = 10, fig.height = 10, fig.cap = "Fig34: Heat Map of Return Stationss", fig.align = "center"}
# Heat map of the return stations
ggmap(map) +
  geom_point(data = locationset, 
             aes(y = Checkout.Station.Latitude, 
                 x = Checkout.Station.Longitude,
                 size = Return.Count),
             color = "red", alpha = 0.5) +
  scale_size(range = c(0, 15)) + 
  guides(fill = FALSE)
```

The size of the circle represents the overall checkouts/returns since B-cycle started. From the two maps it is clear that the stations in downtown are most used. The stations near downtown and in/near the University are the most used behind the downtown stations. 

# __3. Machine Learning to predict the Pass Type__
```{r, warning = FALSE}
if(FALSE)
{
  # Subset the data keeping the necessary variables
  mlsubset <- dataset[c(3, 13)]
  
  # Create partition
  trainIndex <- createDataPartition(mlsubset$Entry.Pass.Type, p = 0.8, list = FALSE, times = 1)
  trainingset <- mlsubset[trainIndex, ]
  testset <- mlsubset[-trainIndex, ]
  
  # Get the necessary variables for analysis
  # Split the data set for 10-fold cross validation, train on 9, test on 1 for all combinations
  trainControl <- trainControl(method = "cv", number = 10)
  metric <- "Accuracy"
  
  # Evaluate 3 different algorithms, make sure the same seed is used
  # Linear Discriminant Analysis
  set.seed(7)
  fit.lda <- train(Entry.Pass.Type~., data = trainingset, method = "lda", 
                   metric = metric, trControl = trainControl)
  # Classification and Regression Test
  set.seed(7)
  fit.cart <- train(Entry.Pass.Type~., data = trainingset, method = "rpart", 
                    metric = metric, trControl = trainControl)
  # Naive Bayes
  set.seed(7)
  fit.nb <- train(Entry.Pass.Type~., data = trainingset, method = "nb", 
                  metric = metric, trControl = trainControl)
  
  # Summarize accuracy of models
  results <- resamples(list(lda = fit.lda, cart = fit.cart, nb = fit.nb))
  summary(results)
  
  # Dot plot of the results
  dotplot(results)
  
  # Compare against the test set
  predictions <- predict(fit.cart, testset)
  confusionMatrix(predictions, testset$Entry.Pass.Type)
}
```

This section explored whether it was possible to use Machine Learning algorithms on the numeric data(trip duration) to predict the pass type. Three algorithms were tested(LDA, CART and Naive Bayes). Among the 3 CART had the best results but the accuracy was still low <70%. Since trip duration was the only quantified numeric data the algorithms didn't perform that well. 

If there was another numeric variable which Boulder B-cycle had provided, may be the distance covered during each trip that would have probably helped with the classification and accuracy of classification.
